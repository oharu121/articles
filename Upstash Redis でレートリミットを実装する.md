# Upstash Redis ã§ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã‚’å®Ÿè£…ã™ã‚‹

# ã¯ã˜ã‚ã«

Web APIãªã©ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã¨ã€ã€ŒçŸ­æ™‚é–“ã«åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ã‚‹ã®ã‚’é˜²ããŸã„ã€ã¨æ€ã†ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

ãã‚“ãªæ™‚ã«ä¾¿åˆ©ãªã®ãŒã€Œ**ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆ**ã€ã§ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€**Upstash Redis** ã‚’ä½¿ã£ã¦ã€ç°¡å˜ã‹ã¤ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã«ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

**ğŸ§© ãªãœãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆãŒå¿…è¦ï¼Ÿ**

Gemini API ã¯ç„¡æ–™æ ãŒã‚ã‚‹ã¨ã¯ã„ãˆã€éå‰°ãªå‘¼ã³å‡ºã—ã¯èª²é‡‘ã‚„åˆ¶é™ã®åŸå› ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ä¸ç‰¹å®šå¤šæ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã™ã‚‹ã‚¢ãƒ—ãƒªã§ã¯ **æ‚ªæ„ã‚ã‚‹é€£æ‰“** ã«ã‚‚å‚™ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**ğŸ¯ å®Ÿç¾ã—ãŸã„ã“ã¨**

* åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè­˜åˆ¥å­ï¼‰ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹å›æ•°ã‚’åˆ¶é™ã—ãŸã„
* åˆ¶é™å›æ•°ã‚’è¶…ãˆãŸã‚‰å‡¦ç†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸã„
* æ¯æ—¥ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã„

ãã“ã§ã€ä»Šå›ã¯ `@upstash/redis` ã‚’ä½¿ã£ã¦ç°¡å˜ã«ã€Œ1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Š1æ—¥5å›ã¾ã§ã€ã¨ã„ã†åˆ¶é™ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

#  Redisã¨ã¯ï¼Ÿ

**Redisï¼ˆãƒªãƒ‡ã‚£ã‚¹ï¼‰** ã¯ã€è¶…é«˜é€Ÿã§å‹•ä½œã™ã‚‹ **ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªå‹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** ã§ã™ã€‚

* ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªï¼ˆRAMï¼‰ä¸Šã«ä¿å­˜ã™ã‚‹ãŸã‚ã€**éå¸¸ã«é«˜é€Ÿ**ã«èª­ã¿æ›¸ãã§ãã‚‹
* ä¸€æ™‚çš„ãªã‚«ã‚¦ãƒ³ãƒˆã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã‚­ãƒ¥ãƒ¼ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãªã©ã«åºƒãä½¿ã‚ã‚Œã¦ã„ã‚‹
* ã‚­ãƒ¼ã¨å€¤ã®çµ„ã¿åˆã‚ã›ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã€ŒNoSQLã€å‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

**ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã®ã‚ˆã†ã«ã€Œå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ä¸€æ™‚çš„ã«ä¿æŒã€ã™ã‚‹ç”¨é€”ã«ã´ã£ãŸã‚Š**ã§ã™ã€‚

# Upstashã¨ã¯ï¼Ÿ

**Upstashï¼ˆã‚¢ãƒƒãƒ—ã‚¹ã‚¿ãƒƒã‚·ãƒ¥ï¼‰** ã¯ã€Redisã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã§æä¾›ã—ã¦ãã‚Œã‚‹ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

ç‰¹å¾´ã¨ã—ã¦ï¼š

* **Vercelã‚„Cloudflare Workersãªã©ã®ã‚µãƒ¼ãƒãƒ¬ã‚¹ç’°å¢ƒ**ã¨ç›¸æ€§ãŒè‰¯ã„
* **REST APIã§Redisã«ã‚¢ã‚¯ã‚»ã‚¹**ã§ãã‚‹ï¼ˆRedisã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šãŒä¸è¦ï¼‰
* **ç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚ã‚Š** â†’ å€‹äººé–‹ç™ºã«ã‚‚å¬‰ã—ã„
* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚¨ãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§**ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·**

ç°¡å˜ã«è¨€ãˆã°ã€

> Redisã‚’è‡ªåˆ†ã§ç«‹ã¡ä¸Šã’ãŸã‚Šç®¡ç†ã›ãšã«ã€Upstashã«ä»»ã›ã¦ã™ãä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã‚‚ã®

ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

**ğŸ”— Redisã¨Upstashã®é–¢ä¿‚**

| ã‚µãƒ¼ãƒ“ã‚¹    | å½¹å‰²                       |
| ------- | ------------------------ |
| Redis   | é«˜é€Ÿãªã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆæœ¬ä½“ï¼‰       |
| Upstash | Redisã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã§ç°¡å˜ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã‚‚ã® |

**ğŸ’¡ ãªãœUpstash Redisï¼Ÿ**

* **REST APIçµŒç”±ã§ä½¿ãˆã‚‹** â†’ Vercelã‚„Cloudflareãªã©ã‚µãƒ¼ãƒãƒ¬ã‚¹ç’°å¢ƒã§ã‚‚å®‰å¿ƒ
* **ç„¡æ–™æ ã‚ã‚Š** â†’ å€‹äººé–‹ç™ºã«ã‚‚æœ€é©
* **è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°** â†’ æ€¥ãªã‚¢ã‚¯ã‚»ã‚¹å¢—ã«ã‚‚è€ãˆã‚‰ã‚Œã‚‹

https://upstash.com/

# Upstash Redisã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãš Upstash Redis ã® REST URL ã¨ Token ã‚’ç™ºè¡Œã—ã€`.env.local` ã«ä¿å­˜ã—ã¾ã™ã€‚

```env
UPSTASH_REDIS_REST_URL=your_redis_url
UPSTASH_REDIS_REST_TOKEN=your_redis_token
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š

```bash
npm install @upstash/redis
```

# ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆé–¢æ•°ã®å®Ÿè£…

```ts:lib/rateLimit.ts
import { Redis } from '@upstash/redis'

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL || '',
  token: process.env.UPSTASH_REDIS_REST_TOKEN || ''
})

/**
 * ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
 * @param identifier IPã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãªã©ã€è­˜åˆ¥å­
 * @returns åˆ¶é™ä»¥å†…ãªã‚‰ trueã€è¶…ãˆã¦ã„ã‚Œã° false
 */
export async function checkRateLimit(identifier: string): Promise<boolean> {
  const key = `rate_limit:${identifier}`;
  const limit = 5; // 1æ—¥ã‚ãŸã‚Šã®æœ€å¤§å›æ•°

  const current = await redis.incr(key);
  
  if (current === 1) {
    await redis.expire(key, 60 * 60 * 24); // 24æ™‚é–“å¾Œã«æœŸé™åˆ‡ã‚Œ
  }

  return current <= limit;
}
```

**ğŸ” è§£èª¬**
* `identifier` ã¯ `IP` ã‚„ `userId`ã€`email` ãªã©ã«ç½®ãæ›ãˆã¦ä½¿ãˆã¾ã™ã€‚

* `redis.incr(key)`
  Redisã§æŒ‡å®šã‚­ãƒ¼ã®å€¤ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¾ã™ã€‚ã‚­ãƒ¼ãŒãªã‘ã‚Œã° `1` ã«åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚

* `redis.expire(key, seconds)`
  æœ‰åŠ¹æœŸé™ã‚’ç§’å˜ä½ã§æŒ‡å®šã€‚ã“ã“ã§ã¯24æ™‚é–“ï¼ˆ`24 * 60 * 60`ï¼‰ã§ã‚­ãƒ¼ãŒè‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

* `current <= limit`
  ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚¹æ•°ãŒåˆ¶é™ä»¥å†…ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

**ğŸ“Œ è£œè¶³ï¼š`identifier`ï¼ˆè­˜åˆ¥å­ï¼‰ã‚’ã©ã†è¨­è¨ˆã™ã‚‹ã‹ï¼Ÿ**

| è­˜åˆ¥å­     | ãƒ¡ãƒªãƒƒãƒˆ            | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ          |
| ------- | --------------- | -------------- |
| IPã‚¢ãƒ‰ãƒ¬ã‚¹  | å®Ÿè£…ãŒç°¡å˜ã€åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚å¯ | åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§å…±æœ‰ã•ã‚Œã‚‹ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID  | ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰æ­£ç¢º      | åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ä½¿ãˆãªã„   |
| ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | è¤‡æ•°ç«¯æœ«ã‚’ã¾ãŸã„ã§ã‚‚åˆ¶å¾¡å¯èƒ½  | åˆ©ç”¨ã«ã¯èªè¨¼ãŒå¿…è¦      |

# Gemini é–¢æ•°ã¨ã®çµ±åˆä¾‹

```ts:pages/api/generate.ts
import type { NextApiRequest, NextApiResponse } from 'next'
import { generateWithGemini } from '@/lib/gemini'
import { checkRateLimit } from '@/lib/rateLimit'

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const prompt = req.body.prompt
  const ip = req.headers['x-forwarded-for'] || req.socket.remoteAddress || 'unknown'

  const allowed = await checkRateLimit(String(ip))

  if (!allowed) {
    return res.status(429).json({ error: 'Rate limit exceeded. Try again tomorrow.' })
  }

  try {
    const result = await generateWithGemini({ prompt })
    res.status(200).json({ result })
  } catch (error) {
    res.status(500).json({ error: 'Failed to generate content' })
  }
}
```

# ãŠã‚ã‚Šã«

æœ¬è¨˜äº‹ã§ã¯ã€**Node.js + Upstash Redis** ã‚’ä½¿ã£ãŸã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã®å®Ÿè£…æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

APIã®ä¿è­·ã‚„ã‚¹ãƒ‘ãƒ é˜²æ­¢ã«éå¸¸ã«æœ‰åŠ¹ãªã®ã§ã€ãœã²å°å…¥ã—ã¦ã¿ã¦ãã ã•ã„ï¼
